name: 游 Test & Deploy React App

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  component-tests:
    name: 游빍 Jest Snapshot & Coverage
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v4

      - name: 游댢游닍 Set up Node, cache and install deps
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: '23.7.0'

      - name: 游빍 Run component tests with coverage
        run: npm run test:coverage:ci

      - name: 游늯 Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  e2e-tests:
    name: 游댌 Cypress E2E Tests
    runs-on: ubuntu-latest
    needs: component-tests

    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v4

      - name: 游댢游닍 Set up Node, cache and install deps
        uses: ./.github/actions/setup-node-deps

      - name: 游댌 Run E2E tests with Cypress
        id: cypress
        run: npm run cypress:ci

      - name: 游뒆 Upload Cypress screenshots (on failure)
        if: failure() && steps.cypress.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots/

  deploy-to-regression:
    name: 游뚾 Deploy to Regression
    runs-on: ubuntu-latest
    needs: e2e-tests

    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v4

      - name: 游댢游닍 Set up Node, cache and install deps
        uses: ./.github/actions/setup-node-deps

      - name: 游끵 Build application
        run: npm run build

      - name: 游뚴 Deploy to regression server (placeholder)
        run: echo "Deploying to regression server..."

  deploy-to-production:
    name: 游 Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-to-regression
    environment:
      name: production

    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v4

      - name: 游댢游닍 Set up Node, cache and install deps
        uses: ./.github/actions/setup-node-deps

      - name: 游끵 Build application
        run: npm run build

      - name: 游 Deploy to production server (placeholder)
        run: echo "Deploying to production server..."
